<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oposiciones — Bloque IV</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    body { display: flex; flex-direction: column; }

    /* ── Mode header ── */
    #mode-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: #1a1a2e;
      height: 48px;
      flex-shrink: 0;
    }
    .mode-tabs { display: flex; gap: 4px; }
    .mode-tab {
      background: transparent;
      border: none;
      color: #8888aa;
      font-size: 0.9rem;
      font-weight: 500;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.15s, color 0.15s;
    }
    .mode-tab:hover { background: rgba(255,255,255,0.08); color: #ccc; }
    .mode-tab.active { background: rgba(255,255,255,0.12); color: #fff; }
    .app-title { color: #8888aa; font-size: 0.85rem; font-weight: 400; }

    /* ── Exam view ── */
    #exam-view {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    /* ── Study view ── */
    #study-view {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #study-sidebar {
      width: 280px;
      min-width: 280px;
      background: #f0f0f5;
      border-right: 1px solid #e0e0e0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      transition: width 0.2s ease, min-width 0.2s ease;
    }
    #study-sidebar.collapsed {
      width: 40px;
      min-width: 40px;
      overflow: hidden;
    }
    #study-sidebar.collapsed #study-sidebar-topics,
    #study-sidebar.collapsed #study-sidebar-sections {
      display: none !important;
    }
    .sidebar-top-bar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 4px 6px;
      flex-shrink: 0;
      border-bottom: 1px solid #e0e0e0;
    }
    #study-sidebar.collapsed .sidebar-top-bar {
      justify-content: center;
      border-bottom-color: transparent;
    }
    .sidebar-collapse-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #777;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.12s, color 0.12s;
    }
    .sidebar-collapse-btn:hover { background: #e0e0e8; color: #333; }
    .study-sidebar-header {
      padding: 16px 20px 12px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #888;
    }
    #study-sidebar-back {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 12px 20px;
      background: none;
      border: none;
      border-bottom: 1px solid #e0e0e0;
      color: #4361ee;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      text-align: left;
      font-family: inherit;
    }
    #study-sidebar-back:hover { background: #eef0fd; }
    .study-sidebar-section-title {
      padding: 10px 20px 8px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #888;
      border-bottom: 1px solid #e0e0e0;
      line-height: 1.4;
    }
    #study-sidebar-toc-nav a {
      display: block;
      padding: 6px 20px;
      color: #555;
      text-decoration: none;
      font-size: 0.875rem;
      line-height: 1.5;
      border-left: 3px solid transparent;
      transition: background 0.12s, border-color 0.12s, color 0.12s;
    }
    #study-sidebar-toc-nav a:hover { background: #e4e4ee; color: #1a1a2e; }
    #study-sidebar-toc-nav a.active {
      background: #dde0f7;
      border-left-color: #4361ee;
      color: #1a1a2e;
      font-weight: 600;
    }
    #study-sidebar-toc-nav a.toc-h3 { padding-left: 32px; font-size: 0.835rem; }
    #study-sidebar-nav a {
      display: block;
      padding: 10px 20px;
      color: #444;
      text-decoration: none;
      font-size: 0.9rem;
      border-left: 3px solid transparent;
      transition: background 0.12s, border-color 0.12s;
    }
    #study-sidebar-nav a:hover { background: #e4e4ee; }
    #study-sidebar-nav a.active {
      background: #dde0f7;
      border-left-color: #4361ee;
      color: #1a1a2e;
      font-weight: 600;
    }

    #study-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 32px 40px;
      min-width: 0;
    }
    .study-content-inner {
      max-width: 900px;
      margin: 0 auto;
    }
    .study-placeholder {
      text-align: center;
      color: #999;
      padding: 80px 20px;
      font-size: 1.1rem;
    }

    /* Markdown rendered styles */
    .study-content-inner h1 { font-size: 1.8rem; color: #1a1a2e; margin: 0 0 24px; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0; scroll-margin-top: 20px; }
    .study-content-inner h2 { font-size: 1.35rem; color: #1a1a2e; margin: 32px 0 16px; padding-bottom: 6px; border-bottom: 1px solid #eee; scroll-margin-top: 20px; }
    .study-content-inner h3 { font-size: 1.1rem; color: #333; margin: 24px 0 12px; scroll-margin-top: 20px; }
    .study-content-inner h4 { font-size: 1rem; color: #444; margin: 20px 0 10px; scroll-margin-top: 20px; }
    .study-content-inner p { margin-bottom: 12px; }
    .study-content-inner ul, .study-content-inner ol { padding-left: 24px; margin-bottom: 12px; }
    .study-content-inner li { margin-bottom: 4px; }
    .study-table-wrapper { overflow-x: auto; margin: 16px 0; -webkit-overflow-scrolling: touch; }
    .study-content-inner table { border-collapse: collapse; width: 100%; font-size: 0.9rem; }
    .study-content-inner th, .study-content-inner td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
    .study-content-inner th { background: #f0f0f5; font-weight: 600; color: #1a1a2e; }
    .study-content-inner tr:nth-child(even) { background: #fafaff; }
    .study-content-inner pre { background: #1e1e2e; color: #cdd6f4; padding: 16px; border-radius: 8px; overflow-x: auto; margin: 16px 0; line-height: 1.5; }
    .study-content-inner pre code { background: none; padding: 0; border-radius: 0; color: inherit; font-size: 0.88em; }
    .study-content-inner code { background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-family: "SF Mono", Consolas, monospace; font-size: 0.88em; }
    .study-content-inner blockquote { border-left: 4px solid #4361ee; background: #f0f2ff; padding: 12px 16px; margin: 16px 0; border-radius: 0 6px 6px 0; }
    .study-content-inner blockquote p { margin-bottom: 4px; }
    .study-content-inner hr { border: none; border-top: 1px solid #e0e0e0; margin: 24px 0; }
    .study-content-inner a { color: #4361ee; }
    .study-content-inner img { max-width: 100%; border-radius: 6px; }
    .study-content-inner strong { color: #1a1a2e; }
    .heading-anchor {
      opacity: 0; margin-left: 8px; font-size: 0.75em;
      color: #4361ee; text-decoration: none; font-weight: 400;
      transition: opacity 0.15s;
    }
    .study-content-inner h1:hover .heading-anchor,
    .study-content-inner h2:hover .heading-anchor,
    .study-content-inner h3:hover .heading-anchor,
    .study-content-inner h4:hover .heading-anchor { opacity: 1; }
    .study-content-inner h1,
    .study-content-inner h2,
    .study-content-inner h3,
    .study-content-inner h4 { position: relative; cursor: pointer; }
    .study-content-inner h1:hover,
    .study-content-inner h2:hover,
    .study-content-inner h3:hover,
    .study-content-inner h4:hover { color: #4361ee; }
    .heading-dropdown {
      display: none; position: absolute;
      top: calc(100% + 6px); left: 0;
      background: #fff; border: 1px solid #e0e0e0;
      border-radius: 8px; box-shadow: 0 4px 18px rgba(0,0,0,0.13);
      min-width: 260px; z-index: 600; overflow: hidden;
    }
    .heading-dropdown.open { display: block; }
    .heading-dropdown-item {
      display: block; width: 100%; padding: 10px 16px;
      background: none; border: none; text-align: left;
      font-size: 0.84rem; font-family: inherit; color: #333;
      cursor: pointer; line-height: 1.4;
    }
    .heading-dropdown-item:not(:disabled):hover { background: #f5f5fa; }
    .heading-dropdown-item + .heading-dropdown-item { border-top: 1px solid #f0f0f4; }
    .heading-dropdown-item:disabled { color: #b0b0b8; cursor: default; }

    /* Active exam filter label */
    #exam-filter-label {
      display: none; align-items: center; justify-content: center; gap: 8px;
      padding: 4px 16px; background: #eef0fd; border-bottom: 1px solid #c5ccf5;
      font-size: 0.8rem; color: #4361ee; font-weight: 500; flex-shrink: 0;
    }
    #exam-filter-label.visible { display: flex; }
    #exam-filter-clear {
      background: none; border: none; cursor: pointer;
      color: #aaa; font-size: 0.85rem; padding: 0 2px; line-height: 1;
    }
    #exam-filter-clear:hover { color: #c0392b; }

    /* Topic select in settings modal */
    .modal-field select {
      width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px;
      font-size: 0.9rem; font-family: inherit; color: #333; background: #fff;
      cursor: pointer;
    }
    .modal-field select:focus { outline: 2px solid #4361ee; border-color: #4361ee; }

    /* "Examen de este tema" button in study sidebar */
    .btn-topic-exam {
      display: flex; align-items: center; gap: 6px;
      width: 100%; padding: 10px 20px;
      background: none; color: #4361ee; border: none;
      border-bottom: 1px solid #e0e0e0; font-size: 0.85rem;
      font-weight: 600; cursor: pointer; font-family: inherit; text-align: left;
    }
    .btn-topic-exam:hover { background: #eef0fd; }

    /* TOC (right sidebar — removed, now in left panel) */

    /* Mobile toggles for study view */
    .study-sidebar-toggle {
      display: none;
      position: fixed;
      top: 56px;
      left: 12px;
      z-index: 800;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .study-sidebar-overlay, .study-toc-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 899;
    }
    .study-sidebar-overlay.visible, .study-toc-overlay.visible { display: block; }

    /* Settings button */
    .btn-settings {
      position: fixed;
      bottom: 76px;
      right: 72px;
      z-index: 900;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      padding: 0;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      border: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      cursor: pointer;
      color: #666;
      transition: opacity 0.2s;
    }
    .btn-settings:hover { background: #f0f0f0; }
    .btn-settings.hidden { display: none; }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.visible { display: flex; }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 28px 32px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      min-width: 340px;
      max-width: 420px;
    }
    .modal h2 { font-size: 1.1rem; color: #1a1a2e; margin-bottom: 20px; }
    .modal-field { margin-bottom: 20px; }
    .modal-field label { display: block; font-size: 0.9rem; color: #555; margin-bottom: 8px; }
    .modal-field .slider-row { display: flex; align-items: center; gap: 12px; }
    .modal-field input[type="range"] { flex: 1; accent-color: #4361ee; }
    .modal-field .slider-value {
      font-weight: 700; font-size: 1.1rem; color: #4361ee;
      min-width: 32px; text-align: center;
    }
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; }
    .modal-actions button {
      padding: 8px 20px; border-radius: 6px; border: none;
      cursor: pointer; font-size: 0.9rem; font-weight: 500;
    }
    .btn-modal-cancel { background: #e8e8e8; color: #333; }
    .btn-modal-cancel:hover { background: #d0d0d0; }
    .btn-modal-apply { background: #4361ee; color: #fff; }
    .btn-modal-apply:hover { background: #3451d1; }


    /* Main content area */
    .content {
      flex: 1;
      overflow: hidden;
      display: flex;
    }
    .pane-left {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      justify-content: center;
      transition: flex 0.25s;
    }
    .pane-left-inner { max-width: 750px; width: 100%; }
    .pane-right {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      border-left: 1px solid #e0e0e0;
      background: #fafafa;
      display: none;
    }
    .pane-right.visible { display: block; }
    .pane-right-inner { max-width: 700px; }
    .pane-right-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .pane-right-header h3 { color: #1a1a2e; font-size: 1.05rem; }
    .btn-close-pane {
      background: none; border: 1px solid #ccc; border-radius: 4px;
      padding: 4px 12px; cursor: pointer; font-size: 0.85rem; color: #666;
    }
    .btn-close-pane:hover { background: #eee; }

    /* Question card */
    .question-card {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 4px solid #4361ee;
    }
    .question-card.correct { border-left-color: #2ecc71; }
    .question-card.wrong { border-left-color: #e74c3c; }
    .question-card.unanswered { border-left-color: #f39c12; }
    .question-header { margin-bottom: 8px; }
    .question-number { font-size: 0.85rem; color: #888; }
    .question-meta { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-bottom: 16px; }
    .btn-original {
      font-size: 0.75rem; color: #888; background: #f0f0f0;
      border: 1px solid #ddd; border-radius: 4px; padding: 3px 8px;
      cursor: pointer; text-decoration: none; white-space: nowrap;
    }
    .btn-original:hover { background: #e0e0e0; color: #555; }
    .btn-study {
      font-size: 0.75rem; color: #4361ee; background: #eef0fd;
      border: 1px solid #c5ccf5; border-radius: 4px; padding: 3px 8px;
      cursor: pointer; text-decoration: none; white-space: nowrap;
    }
    .btn-study:hover { background: #d8dcfb; color: #2a3fc0; }
    .question-text { font-size: 1.05rem; font-weight: 500; margin-bottom: 16px; white-space: pre-line; overflow-x: auto; }
    .choices label {
      display: flex;
      align-items: baseline;
      padding: 10px 14px;
      margin-bottom: 6px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: background 0.15s;
    }
    .choices label span { flex: 1; }
    .choices label:hover { background: #f0f0f0; }
    .choices.graded label { pointer-events: none; cursor: default; }
    .choices input[type="radio"] { display: none; }
    .choices kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px; height: 24px;
      font-size: 0.8rem;
      font-weight: 600;
      background: #e8e8e8;
      border: 1px solid #ccc;
      border-bottom-width: 2px;
      border-radius: 4px;
      margin-right: 10px;
      flex-shrink: 0;
      color: #555;
    }
    .choices label.selected kbd { background: #c5d5f7; border-color: #4361ee; color: #4361ee; }
    .choices label.correct-answer kbd, .choices label.was-correct kbd { background: #b8e6c8; border-color: #2ecc71; color: #1a7a3a; }
    .choices label.wrong-answer kbd { background: #f0c0c5; border-color: #e74c3c; color: #a71d2a; }
    .choices label.selected { background: #e8f0fe; border-color: #4361ee; }
    .choices label.correct-answer { background: #d4edda; border-color: #2ecc71; }
    .choices label.wrong-answer { background: #f8d7da; border-color: #e74c3c; }
    .choices label.was-correct { background: #d4edda; border-color: #2ecc71; }

    .explanation-box {
      display: none;
      margin-top: 16px;
      padding: 14px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 6px;
      font-size: 0.95rem;
    }
    .explanation-box.visible { display: block; }
    .explanation-box ul, .pane-right ul { margin: 8px 0 8px 20px; }
    .explanation-box li, .pane-right li { margin-bottom: 4px; }
    .explanation-box p, .pane-right p { margin-bottom: 8px; }
    .explanation-box ol, .pane-right ol { margin: 8px 0 8px 20px; }
    .explanation-box code, .pane-right code {
      background: #e9ecef; padding: 1px 5px; border-radius: 3px;
      font-family: "SF Mono", Consolas, monospace; font-size: 0.88em;
    }
    .explanation-box pre, .pane-right pre {
      background: #1e1e2e; color: #cdd6f4; padding: 14px 16px; border-radius: 6px;
      overflow-x: auto; margin: 8px 0; line-height: 1.5;
    }
    .explanation-box pre code, .pane-right pre code {
      background: none; padding: 0; border-radius: 0; color: inherit;
      font-size: 0.85em;
    }
    .pane-right a { color: #4361ee; word-break: break-all; }
    .pane-right { font-size: 0.93rem; line-height: 1.7; }
    .btn-detail {
      margin-top: 10px; background: none; border: 1px solid #888;
      padding: 6px 14px; border-radius: 4px; cursor: pointer;
      font-size: 0.85rem; color: #555;
    }
    .btn-detail:hover { background: #eee; }

    /* Results view */
    .results-view {
      background: #fff;
      border-radius: 8px;
      padding: 32px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
    }
    .results-view h2 { margin-bottom: 20px; color: #1a1a2e; }
    .results-grid {
      display: flex; justify-content: center; gap: 32px;
      margin-bottom: 24px; flex-wrap: wrap;
    }
    .result-stat { text-align: center; min-width: 120px; }
    .result-stat .number { font-size: 2.2rem; font-weight: 700; }
    .result-stat .label { font-size: 0.9rem; color: #666; }
    .result-stat .percent { font-size: 0.85rem; color: #888; }
    .stat-correct .number { color: #2ecc71; }
    .stat-wrong .number { color: #e74c3c; }
    .stat-unanswered .number { color: #f39c12; }

    /* Bottom navigation bar */
    .bottom-bar {
      padding: 12px 20px;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      gap: 12px;
    }
    .nav-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s;
      font-weight: 500;
    }
    .nav-btn:disabled { opacity: 0.4; cursor: default; }
    .btn-prev, .btn-next { background: #e8e8e8; color: #333; }
    .btn-prev:hover:not(:disabled), .btn-next:hover:not(:disabled) { background: #d0d0d0; }
    .btn-submit { background: #4361ee; color: #fff; }
    .btn-submit:hover { background: #3451d1; }
    .btn-new { background: #2ecc71; color: #fff; }
    .btn-new:hover { background: #27ae60; }
    .btn-error-nav { background: #e74c3c; color: #fff; }
    .btn-error-nav:hover { background: #c0392b; }
    .btn-next-q { background: #4361ee; color: #fff; }
    .btn-next-q:hover { background: #3a56d4; }
    .bottom-center { display: flex; gap: 8px; }
    kbd {
      display: inline-block;
      padding: 1px 6px;
      font-size: 0.75rem;
      font-family: inherit;
      background: rgba(0,0,0,0.08);
      border-radius: 3px;
      margin-left: 4px;
      vertical-align: middle;
    }
    .nav-btn kbd { background: rgba(255,255,255,0.25); }
    .btn-detail kbd { background: rgba(0,0,0,0.08); }

    /* Close button for mobile overlay (hidden on desktop) */
    .btn-close-overlay {
      display: none;
      position: sticky;
      top: 0;
      z-index: 10;
      background: #fff;
      border: none;
      border-bottom: 1px solid #e0e0e0;
      padding: 12px 16px;
      font-size: 1rem;
      font-weight: 500;
      color: #4361ee;
      cursor: pointer;
      text-align: right;
      width: 100%;
    }

    .btn-icon { display: none; }
    .btn-expl-toggle { display: none; }
    .btn-expl-detail-toggle { display: none; }

    /* ── Mobile responsive ── */
    @media (max-width: 768px) {

      /* 1. Explanation pane → full-screen overlay */
      .pane-right.visible {
        position: fixed;
        inset: 0;
        z-index: 1000;
        background: #fff;
        border-left: none;
        padding: 0;
        display: flex;
        flex-direction: column;
      }
      .pane-right .btn-close-overlay { display: none; }
      .pane-right .btn-detail { display: none; }
      .pane-right.visible .pane-right-inner {
        padding: 16px;
        overflow-y: auto;
        flex: 1;
      }

      /* 2. Hide kbd hints (keep choice numbers) */
      .nav-btn kbd,
      .btn-detail kbd { display: none; }
      .choices kbd {
        width: 26px; height: 26px;
        border-radius: 50%;
        border: none;
        border-bottom-width: 0;
        background: #e8e8e8;
        color: #555;
        font-size: 0.8rem;
      }
      .choices label {
        border: 2px solid #ddd;
        background: #fff;
        border-radius: 10px;
        padding: 12px 14px;
        margin-bottom: 8px;
        align-items: center;
      }
      .choices label.selected { border-color: #4361ee; }
      .choices label.selected kbd { background: #4361ee; color: #fff; }
      .choices label.correct-answer,
      .choices label.was-correct { border-color: #2ecc71; }
      .choices label.correct-answer kbd,
      .choices label.was-correct kbd { background: #2ecc71; color: #fff; }
      .choices label.wrong-answer { border-color: #e74c3c; }
      .choices label.wrong-answer kbd { background: #e74c3c; color: #fff; }

      /* 3. Hide floating settings button */
      .btn-settings.hidden { display: none; }
      .btn-expl-toggle {
        position: fixed;
        bottom: 76px;
        right: 16px;
        z-index: 1100;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        padding: 0;
        font-size: 1.3rem;
        align-items: center;
        justify-content: center;
        background: #4361ee;
        color: #fff;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        cursor: pointer;
      }
      .btn-expl-toggle.visible { display: flex; }
      .btn-expl-toggle.overlay-open {
        bottom: 20px;
        right: 16px;
        width: 56px;
        height: 56px;
        font-size: 1.5rem;
        background: #e8e8e8;
        color: #333;
      }
      .btn-expl-detail-toggle {
        position: fixed;
        bottom: 20px;
        right: 80px;
        z-index: 1100;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        padding: 0;
        font-size: 1rem;
        font-weight: 700;
        align-items: center;
        justify-content: center;
        background: #4361ee;
        color: #fff;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        cursor: pointer;
      }
      .btn-expl-detail-toggle.visible { display: flex; }

      /* 4. Bottom bar: icon-only equal buttons */
      .btn-icon { display: flex; }
      .btn-label { display: none; }
      .bottom-bar {
        padding: 10px 12px;
        gap: 8px;
        justify-content: center;
      }
      .bottom-bar .nav-btn {
        flex: 1;
        height: 48px;
        padding: 0;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* 5. Modal responsive */
      .modal {
        min-width: auto;
        width: 90vw;
        max-width: 420px;
        padding: 20px 20px;
      }

      /* 6. General spacing */
      .question-card { padding: 16px; }
      .pane-left { padding: 12px; }
      .question-text { font-size: 1rem; }
      .choices label { padding: 8px 10px; }

      /* 7. (settings button covered above) */

      /* ── Study view mobile ── */
      .app-title { display: none; }
      #study-sidebar {
        position: fixed;
        left: -300px;
        top: 48px;
        bottom: 0;
        z-index: 900;
        width: 280px;
        transition: left 0.25s ease;
      }
      #study-sidebar.open { left: 0; }
      .study-sidebar-toggle { display: flex; }
      #study-content { padding: 16px; padding-top: 60px; }
      .sidebar-top-bar { display: none; }
      .study-content-inner h1 { font-size: 1.4rem; }
      .study-content-inner h2 { font-size: 1.15rem; }
      .study-content-inner h3 { font-size: 1rem; }
      .study-content-inner { font-size: 0.93rem; }
      .study-content-inner table { font-size: 0.82rem; }
    }

    /* ── Ask Claude chat ── */
    .btn-ask-claude {
      position: fixed;
      bottom: 76px;
      right: 16px;
      z-index: 1100;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: #1a1a2e;
      color: #fff;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 12px rgba(0,0,0,0.25);
      cursor: pointer;
      transition: transform 0.15s, background 0.15s;
    }
    .btn-ask-claude:hover { background: #4361ee; transform: scale(1.05); }
    .btn-ask-claude.active { background: #4361ee; }
    .btn-ask-claude.active .icon-chat-open { display: none; }
    .btn-ask-claude.active .icon-chat-close { display: block !important; }
    body.mode-study .btn-ask-claude { bottom: 16px; right: 16px; }

    #content-wrapper {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-height: 0;
    }
    #views-area {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-panel {
      display: none;
      flex-direction: column;
      flex: none;
      width: 700px;
      background: #fff;
      border-left: 1px solid #e0e0e0;
      position: relative;
    }
    .chat-panel.open { display: flex; }
    .chat-resize-handle {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      z-index: 10;
    }
    .chat-resize-handle:hover,
    .chat-resize-handle.dragging { background: #4361ee55; }

    .chat-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      background: #1a1a2e;
      color: #fff;
      height: 48px;
      flex-shrink: 0;
      font-size: 0.95rem;
      font-weight: 600;
    }
    .chat-close-btn {
      background: none;
      border: none;
      color: #aaa;
      font-size: 1.1rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      line-height: 1;
    }
    .chat-close-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

    .chat-context-label {
      padding: 7px 14px;
      background: #f0f2ff;
      border-bottom: 1px solid #e0e8ff;
      font-size: 0.79rem;
      color: #4361ee;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 0;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chat-notice {
      text-align: center;
      font-size: 0.78rem;
      color: #aaa;
      padding: 6px 12px;
      background: #f5f5f5;
      border-radius: 12px;
      align-self: center;
    }
    .chat-msg { display: flex; max-width: 100%; }
    .chat-msg.user { justify-content: flex-end; }
    .chat-msg.assistant, .chat-msg.error { justify-content: flex-start; }
    .chat-msg-bubble {
      max-width: 85%;
      padding: 10px 13px;
      border-radius: 12px;
      font-size: 0.87rem;
      line-height: 1.55;
      word-break: break-word;
    }
    .chat-msg.user .chat-msg-bubble {
      background: #4361ee;
      color: #fff;
      border-radius: 12px 12px 4px 12px;
    }
    .chat-msg.assistant .chat-msg-bubble {
      max-width: 100%;
      padding: 14px 18px;
      font-size: 0.9rem;
      line-height: 1.65;
      background: #f0f0f5;
      color: #1a1a2e;
      border-radius: 12px 12px 12px 4px;
    }
    .chat-msg.error .chat-msg-bubble {
      background: #ffeef0;
      color: #c0392b;
      border: 1px solid #f5c6cb;
      border-radius: 8px;
      font-size: 0.83rem;
    }
    .chat-msg.assistant .chat-msg-bubble h1,
    .chat-msg.assistant .chat-msg-bubble h2,
    .chat-msg.assistant .chat-msg-bubble h3 {
      margin: 14px 0 6px; font-weight: 700; color: #1a1a2e; line-height: 1.3;
    }
    .chat-msg.assistant .chat-msg-bubble h1 { font-size: 1.15em; }
    .chat-msg.assistant .chat-msg-bubble h2 { font-size: 1.05em; }
    .chat-msg.assistant .chat-msg-bubble h3 { font-size: 0.97em; }
    .chat-msg.assistant .chat-msg-bubble h1:first-child,
    .chat-msg.assistant .chat-msg-bubble h2:first-child,
    .chat-msg.assistant .chat-msg-bubble h3:first-child { margin-top: 0; }
    .chat-msg.assistant .chat-msg-bubble hr { border: none; border-top: 1px solid #d8d8e8; margin: 10px 0; }
    .chat-msg.assistant .chat-msg-bubble table { border-collapse: collapse; width: 100%; margin: 8px 0; font-size: 0.92em; }
    .chat-msg.assistant .chat-msg-bubble th,
    .chat-msg.assistant .chat-msg-bubble td { padding: 6px 10px; border: 1px solid #d0d0e0; text-align: left; }
    .chat-msg.assistant .chat-msg-bubble th { background: #e8e8f4; font-weight: 600; }
    .chat-msg.assistant .chat-msg-bubble p { margin-bottom: 8px; }
    .chat-msg.assistant .chat-msg-bubble p:last-child { margin-bottom: 0; }
    .chat-msg.assistant .chat-msg-bubble ul,
    .chat-msg.assistant .chat-msg-bubble ol { margin: 6px 0 6px 18px; }
    .chat-msg.assistant .chat-msg-bubble li { margin-bottom: 4px; }
    .chat-msg.assistant .chat-msg-bubble code {
      background: #e8e8ee; padding: 1px 5px; border-radius: 3px;
      font-family: "SF Mono", Consolas, monospace; font-size: 0.85em;
    }
    .chat-msg.assistant .chat-msg-bubble pre {
      background: #1e1e2e; color: #cdd6f4; padding: 10px 12px;
      border-radius: 6px; overflow-x: auto; margin: 8px 0; font-size: 0.82em;
    }
    .chat-msg.assistant .chat-msg-bubble pre code { background: none; padding: 0; border-radius: 0; }
    .chat-msg.assistant .chat-msg-bubble strong { color: #1a1a2e; }

    .chat-typing {
      display: flex;
      gap: 5px;
      align-items: center;
      padding: 13px 16px !important;
    }
    .chat-typing span {
      width: 7px; height: 7px;
      background: #aaa;
      border-radius: 50%;
      animation: chatBounce 1.2s infinite ease-in-out;
    }
    .chat-typing span:nth-child(2) { animation-delay: 0.2s; }
    .chat-typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes chatBounce {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-6px); opacity: 1; }
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      border-top: 1px solid #e0e0e0;
      flex-shrink: 0;
      background: #fff;
    }
    .chat-input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.87rem;
      resize: none;
      height: 44px;
      max-height: 120px;
      font-family: inherit;
      line-height: 1.5;
      overflow-y: auto;
    }
    .chat-input:focus { outline: none; border-color: #4361ee; }
    .chat-send-btn {
      width: 44px; height: 44px;
      border-radius: 8px;
      background: #4361ee;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.15s;
    }
    .chat-send-btn:hover { background: #3451d1; }
    .chat-send-btn:disabled { opacity: 0.5; cursor: default; }

    @media (max-width: 768px) {
      .chat-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1500;
        flex: none;
        border-left: none;
        padding-left: env(safe-area-inset-left, 0px);
        padding-right: env(safe-area-inset-right, 0px);
      }
      .chat-panel.open { display: flex; }
      .chat-resize-handle { display: none; }
      .btn-ask-claude { z-index: 1600; } /* stays above chat panel so user can tap to close */
      .chat-input { min-width: 0; }
    }
  </style>
</head>
<body>
  <!-- Mode header -->
  <div id="mode-header">
    <div class="mode-tabs">
      <button class="mode-tab active" data-mode="exam" onclick="switchMode('exam')">Examen</button>
      <button class="mode-tab" data-mode="study" onclick="switchMode('study')">Estudiar</button>
    </div>
    <div class="app-title">Oposiciones — Bloque IV</div>
  </div>

  <div id="content-wrapper">
  <div id="views-area">

  <!-- Exam view -->
  <div id="exam-view">
    <div class="modal-overlay" id="confirm-overlay">
      <div class="modal">
        <h2>Comprobar examen</h2>
        <p id="confirm-msg" style="font-size:0.95rem;color:#555;margin-bottom:20px;"></p>
        <div class="modal-actions">
          <button class="btn-modal-cancel" onclick="closeConfirm()">Cancelar</button>
          <button class="btn-modal-apply" onclick="confirmCheckExam()">Comprobar</button>
        </div>
      </div>
    </div>
    <div class="modal-overlay" id="modal-overlay">
      <div class="modal">
        <h2>Ajustes del examen</h2>
        <div class="modal-field">
          <label>Preguntas por examen</label>
          <div class="slider-row">
            <input type="range" id="slider-count" min="1" max="352" step="1" value="20">
            <span class="slider-value" id="slider-value">20</span>
          </div>
        </div>
        <div class="modal-field">
          <label>Filtrar por tema</label>
          <select id="topic-filter-select">
            <option value="">Todos los temas</option>
          </select>
        </div>
        <div class="modal-actions">
          <button class="btn-modal-cancel" onclick="closeSettings()">Cancelar</button>
          <button class="btn-modal-apply" onclick="applySettings()">Aplicar</button>
        </div>
      </div>
    </div>
    <div id="exam-filter-label">
      <span id="exam-filter-label-text"></span>
      <button id="exam-filter-clear" title="Quitar filtro">&#10005;</button>
    </div>
    <button class="btn-settings" id="btn-settings" onclick="openSettings()" title="Ajustes">&#9881;</button>
    <button class="btn-expl-toggle" id="btn-expl-toggle" onclick="toggleExplanationOverlay()" title="Ver explicación">&#128161;</button>
    <button class="btn-expl-detail-toggle" id="btn-expl-detail-toggle" onclick="toggleLongExplanation()" title="Cambiar detalle">&#8505;</button>
    <div class="content">
      <div class="pane-left"><div class="pane-left-inner" id="view"></div></div>
      <div class="pane-right" id="pane-right"><button class="btn-close-overlay" onclick="hideExplanationPane()">Cerrar &times;</button><div class="pane-right-inner" id="pane-right-inner"></div></div>
    </div>
    <div class="bottom-bar" id="bottom-bar"></div>
  </div>

  <!-- Study view -->
  <div id="study-view" style="display:none">
    <button class="study-sidebar-toggle" id="study-sidebar-toggle" onclick="toggleStudySidebar()">&#9776;</button>
    <div class="study-sidebar-overlay" id="study-sidebar-overlay" onclick="toggleStudySidebar()"></div>
    <aside id="study-sidebar">
      <div class="sidebar-top-bar">
        <button class="sidebar-collapse-btn" id="sidebar-collapse-btn" onclick="toggleSidebarCollapse()" title="Contraer panel">
          <svg class="icon-collapse" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="16" height="16" rx="2" stroke="currentColor" stroke-width="1.4"/>
            <line x1="6" y1="1" x2="6" y2="17" stroke="currentColor" stroke-width="1.4"/>
            <rect x="1" y="1" width="5" height="16" rx="1.5" fill="currentColor" fill-opacity="0.2"/>
            <polyline points="10.5,6.5 8.5,9 10.5,11.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          </svg>
          <svg class="icon-expand" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:none">
            <rect x="1" y="1" width="16" height="16" rx="2" stroke="currentColor" stroke-width="1.4"/>
            <line x1="6" y1="1" x2="6" y2="17" stroke="currentColor" stroke-width="1.4"/>
            <polyline points="8.5,6.5 10.5,9 8.5,11.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          </svg>
        </button>
      </div>
      <div id="study-sidebar-topics">
        <div class="study-sidebar-header">Temario</div>
        <nav id="study-sidebar-nav"></nav>
      </div>
      <div id="study-sidebar-sections" style="display:none">
        <button id="study-sidebar-back">&#8592; Todos los temas</button>
        <button class="btn-topic-exam" id="btn-topic-exam">&#128221; Examen de este tema</button>
        <div class="study-sidebar-section-title" id="study-sidebar-section-title"></div>
        <nav id="study-sidebar-toc-nav"></nav>
      </div>
    </aside>
    <main id="study-content">
      <div class="study-content-inner" id="study-content-inner">
        <div class="study-placeholder">Selecciona un tema del sidebar para empezar a estudiar.</div>
      </div>
    </main>
    <div class="study-toc-overlay" id="study-toc-overlay" onclick="toggleStudyToc()"></div>
  </div>

  </div> <!-- end views-area -->

  <div class="chat-panel" id="chat-panel">
    <div class="chat-resize-handle" id="chat-resize-handle"></div>
    <div class="chat-panel-header">
      <span>Preguntar a Claude</span>
      <button class="chat-close-btn" id="chat-close-btn">&#10005;</button>
    </div>
    <div class="chat-context-label" id="chat-context-label"></div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input-row">
      <textarea class="chat-input" id="chat-input" placeholder="Escribe tu pregunta..." rows="1"></textarea>
      <button class="chat-send-btn" id="chat-send-btn" title="Enviar">&#10148;</button>
    </div>
  </div>

  </div> <!-- end content-wrapper -->

  <!-- Ask Claude -->
  <button class="btn-ask-claude" id="btn-ask-claude" title="Preguntar a Claude">
    <svg class="icon-chat-open" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    <svg class="icon-chat-close" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:none"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
  </button>

  <div class="modal-overlay" id="api-key-overlay">
    <div class="modal">
      <h2>Clave de API de Anthropic</h2>
      <div class="modal-field">
        <label>Introduce tu clave de API para usar el asistente de Claude</label>
        <input type="password" id="api-key-input" placeholder="sk-ant-..." style="width:100%;border:1px solid #ddd;border-radius:6px;padding:10px 12px;font-size:0.9rem;font-family:inherit;margin-top:4px;">
      </div>
      <div class="modal-actions">
        <button class="btn-modal-cancel" onclick="closeApiKeyModal()">Cancelar</button>
        <button class="btn-modal-apply" onclick="applyApiKey()">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    let appMode = 'exam'; // 'exam' | 'study'
    let examSize = 20;
    let allQuestions = [];
    let examQuestions = [];
    let answers = [];       // user's selected answer per question (-1 = unanswered)
    let currentIdx = 0;
    let graded = false;
    let gradeResults = [];  // 'correct' | 'wrong' | 'unanswered' per question
    let errorIndices = [];
    let currentErrorIdx = 0;
    let examTopicFilter   = null;  // null = all; integer = topic id
    let examSectionFilter = null;  // null = all; string = section slug
    const sectionQuestionCounts = new Map(); // section slug → direct question count
    const slugToSectionText = new Map();     // section slug → original section text

    function getFilteredPool() {
      return allQuestions.filter(q => {
        if (examTopicFilter && q.topic !== examTopicFilter) return false;
        if (examSectionFilter) {
          // Resolve the filter slug back to its original text so we can extract
          // the leading section number (e.g. "2.4") and match all subsections
          // (e.g. "2.4.1", "2.4.2") in addition to the section itself.
          const filterText = slugToSectionText.get(examSectionFilter);
          const filterNum  = filterText?.trim().match(/^[\d.]+/)?.[0].replace(/\.$/, '');
          if (filterNum) {
            const qNum = q.section.trim().match(/^[\d.]+/)?.[0].replace(/\.$/, '') ?? '';
            if (qNum !== filterNum && !qNum.startsWith(filterNum + '.')) return false;
          } else {
            // Non-numbered section — fall back to exact slug match
            if (sectionToSlug(q.section) !== examSectionFilter) return false;
          }
        }
        return true;
      });
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function renderMarkdown(text) {
      if (!text) return '';
      // Extract fenced code blocks first, replace with placeholders
      const codeBlocks = [];
      text = text.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
        const escaped = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        codeBlocks.push('<pre><code>' + escaped.replace(/\n$/, '') + '</code></pre>');
        return '\n\n%%CODEBLOCK_' + (codeBlocks.length - 1) + '%%\n\n';
      });
      const blocks = text.split(/\n\n+/);
      return blocks.map(block => {
        const placeholder = block.trim().match(/^%%CODEBLOCK_(\d+)%%$/);
        if (placeholder) return codeBlocks[parseInt(placeholder[1])];
        const lines = block.split('\n');
        const isList = lines.every(l => /^\s*[-]/.test(l) || l.trim() === '');
        const isNumbered = lines.every(l => /^\s*\d+\./.test(l) || l.trim() === '');
        if (isList) {
          const items = lines.filter(l => l.trim()).map(l => '<li>' + inlineFormat(l.replace(/^\s*[-]\s*/, '')) + '</li>');
          return '<ul>' + items.join('') + '</ul>';
        }
        if (isNumbered) {
          const items = lines.filter(l => l.trim()).map(l => '<li>' + inlineFormat(l.replace(/^\s*\d+\.\s*/, '')) + '</li>');
          return '<ol>' + items.join('') + '</ol>';
        }
        let html = '';
        let inList = false;
        for (const line of lines) {
          if (/^\s*[-]\s/.test(line)) {
            if (!inList) { html += '<ul>'; inList = true; }
            html += '<li>' + inlineFormat(line.replace(/^\s*[-]\s*/, '')) + '</li>';
          } else {
            if (inList) { html += '</ul>'; inList = false; }
            if (line.trim()) html += '<p>' + inlineFormat(line) + '</p>';
          }
        }
        if (inList) html += '</ul>';
        return html;
      }).join('');
    }

    function sectionToSlug(text) {
      return text.trim()
        .replace(/^#+\s*/, '')
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .substring(0, 80);
    }

    function inlineFormat(text) {
      text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
      text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
      text = text.replace(/(https?:\/\/[^\s<,)]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
      return text;
    }

    // --- Rendering ---

    function renderQuestion(i) {
      const q = examQuestions[i];
      const view = document.getElementById('view');
      const labels = ['1', '2', '3', '4'];

      let choicesHtml = '';
      q.choices.forEach((c, ci) => {
        let cls = '';
        if (!graded && answers[i] === ci) cls = 'selected';
        if (graded) {
          if (ci === q.answer) cls = gradeResults[i] === 'correct' ? 'correct-answer' : 'was-correct';
          if (ci === answers[i] && ci !== q.answer) cls = 'wrong-answer';
        }
        const disabled = graded ? 'disabled' : '';
        choicesHtml += `<label class="${cls}" data-ci="${ci}">
          <input type="radio" name="q" value="${ci}" ${answers[i] === ci ? 'checked' : ''} ${disabled}>
          <kbd>${labels[ci]}</kbd><span>${c}</span>
        </label>`;
      });

      let cardClass = 'question-card';
      if (graded) cardClass += ' ' + gradeResults[i];

      const examUrl = 'examenes/' + encodeURIComponent(q.original_exam);
      const studyHref = (q.topic && q.section)
        ? `#study/${q.topic}/${sectionToSlug(q.section)}`
        : null;
      const studyBtn = studyHref
        ? `<a class="btn-study" href="${studyHref}" target="_blank" title="Estudiar: ${q.section}">Estudiar sección</a>`
        : '';
      view.innerHTML = `<div class="${cardClass}">
        <div class="question-header">
          <div class="question-number">Pregunta ${i + 1} de ${examQuestions.length}</div>
        </div>
        <div class="question-text">${q.question}</div>
        <div class="question-meta">
          ${studyBtn}
          <a class="btn-original" href="${examUrl}" target="_blank" title="Abrir examen original">${q.original_exam} #${q.original_number}</a>
        </div>
        <div class="choices${graded ? ' graded' : ''}" id="choices">${choicesHtml}</div>
      </div>`;

      // Show short explanation in right pane after grading
      if (graded) {
        if (isMobile()) {
          prepareExplanationPane(q, 'short');
        } else {
          showExplanationPane(q, 'short');
        }
      } else {
        hideExplanationPane();
      }
      updateExplButtons();

      // Choice click handlers
      if (!graded) {
        view.querySelectorAll('#choices label').forEach(label => {
          label.addEventListener('click', () => {
            const ci = parseInt(label.dataset.ci);
            answers[i] = ci;
            document.getElementById('btn-settings').classList.add('hidden');
            view.querySelectorAll('#choices label').forEach(l => l.classList.remove('selected'));
            label.classList.add('selected');
            label.querySelector('input').checked = true;
            // Auto-advance after short delay
            if (i < examQuestions.length - 1) {
              setTimeout(() => { currentIdx = i + 1; render(); }, 350);
            } else {
              renderBottomBar();
            }
          });
        });
      }

    }

    let currentExplMode = 'short'; // 'short' or 'long'

    function showExplanationPane(q, mode) {
      currentExplMode = mode;
      const pane = document.getElementById('pane-right');
      const inner = document.getElementById('pane-right-inner');
      const isShort = mode === 'short';
      inner.innerHTML = `
        <div class="pane-right-header">
          <h3>${isShort ? 'Explicación' : 'Explicación detallada'}</h3>
        </div>
        ${renderMarkdown(isShort ? q.short_explanation : q.long_explanation)}
        <div style="margin-top:16px;">
          <button class="btn-detail" id="btn-toggle-expl">${isShort ? 'Ver explicación detallada' : 'Ver explicación breve'} <kbd>i</kbd></button>
        </div>`;
      pane.classList.add('visible');
      pane.scrollTop = 0;
      document.getElementById('btn-toggle-expl').addEventListener('click', () => {
        showExplanationPane(q, isShort ? 'long' : 'short');
      });
    }

    function hideExplanationPane() {
      document.getElementById('pane-right').classList.remove('visible');
      updateExplButtons();
    }

    function prepareExplanationPane(q, mode) {
      currentExplMode = mode;
      const inner = document.getElementById('pane-right-inner');
      const isShort = mode === 'short';
      inner.innerHTML = `
        <div class="pane-right-header">
          <h3>${isShort ? 'Explicación' : 'Explicación detallada'}</h3>
        </div>
        ${renderMarkdown(isShort ? q.short_explanation : q.long_explanation)}
        <div style="margin-top:16px;">
          <button class="btn-detail" id="btn-toggle-expl">${isShort ? 'Ver explicación detallada' : 'Ver explicación breve'} <kbd>i</kbd></button>
        </div>`;
      document.getElementById('btn-toggle-expl').addEventListener('click', () => {
        showExplanationPane(q, isShort ? 'long' : 'short');
      });
    }

    function isMobile() {
      return window.matchMedia('(max-width: 768px)').matches;
    }

    function toggleExplanationOverlay() {
      const pane = document.getElementById('pane-right');
      if (pane.classList.contains('visible')) {
        hideExplanationPane();
      } else {
        pane.classList.add('visible');
        pane.scrollTop = 0;
      }
      updateExplButtons();
    }

    function updateExplButtons() {
      const btnToggle = document.getElementById('btn-expl-toggle');
      const btnDetail = document.getElementById('btn-expl-detail-toggle');
      const paneOpen = document.getElementById('pane-right').classList.contains('visible');
      const show = graded && currentIdx >= 0;

      if (show) {
        btnToggle.classList.add('visible');
      } else {
        btnToggle.classList.remove('visible');
      }

      if (paneOpen) {
        btnToggle.classList.add('overlay-open');
        btnToggle.innerHTML = '&#10005;';
      } else {
        btnToggle.classList.remove('overlay-open');
        btnToggle.innerHTML = '&#128161;';
      }

      if (show && paneOpen && isMobile()) {
        btnDetail.classList.add('visible');
        btnDetail.textContent = currentExplMode === 'short' ? '+i' : '\u2212i';
      } else {
        btnDetail.classList.remove('visible');
      }
    }

    function renderResults() {
      hideExplanationPane();
      updateExplButtons();
      const view = document.getElementById('view');
      const correct = gradeResults.filter(r => r === 'correct').length;
      const wrong = gradeResults.filter(r => r === 'wrong').length;
      const unanswered = gradeResults.filter(r => r === 'unanswered').length;

      view.innerHTML = `<div class="results-view">
        <h2>Resultados</h2>
        <div class="results-grid">
          <div class="result-stat stat-correct">
            <div class="number">${correct}</div>
            <div class="label">Aciertos</div>
            <div class="percent">${((correct / examQuestions.length) * 100).toFixed(0)}%</div>
          </div>
          <div class="result-stat stat-wrong">
            <div class="number">${wrong}</div>
            <div class="label">Fallos</div>
            <div class="percent">${((wrong / examQuestions.length) * 100).toFixed(0)}%</div>
          </div>
          <div class="result-stat stat-unanswered">
            <div class="number">${unanswered}</div>
            <div class="label">Sin contestar</div>
            <div class="percent">${((unanswered / examQuestions.length) * 100).toFixed(0)}%</div>
          </div>
        </div>
      </div>`;
    }

    function renderBottomBar() {
      const bar = document.getElementById('bottom-bar');

      if (!graded) {
        const isFirst = currentIdx === 0;
        const isLast = currentIdx === examQuestions.length - 1;

        bar.innerHTML = `
          <button class="nav-btn btn-prev" ${isFirst ? 'disabled' : ''} onclick="go(-1)"><span class="btn-icon">&#8592;</span><span class="btn-label">&larr; Anterior</span></button>
          <button class="nav-btn btn-submit" onclick="checkExam()"><span class="btn-icon">&#10003;</span><span class="btn-label">Comprobar examen <kbd>&#8984;Enter</kbd></span></button>
          <button class="nav-btn btn-next" ${isLast ? 'disabled' : ''} onclick="go(1)"><span class="btn-icon">&#8594;</span><span class="btn-label">Siguiente &rarr;</span></button>`;
      } else {
        const hasErrors = errorIndices.length > 0;
        bar.innerHTML = `
          <button class="nav-btn btn-new" onclick="newExam()"><span class="btn-icon">&#8634;</span><span class="btn-label">Nuevo examen <kbd>&#8984;R</kbd></span></button>
          <button class="nav-btn btn-next-q" onclick="nextQuestion()"><span class="btn-icon">&#8594;</span><span class="btn-label">Siguiente <kbd>Space</kbd></span></button>
          ${hasErrors ? `<button class="nav-btn btn-error-nav" onclick="nextError()"><span class="btn-icon">&#9888;</span><span class="btn-label">Siguiente error (${errorIndices.length}) <kbd>&rarr;</kbd></span></button>` : ''}`;
      }
    }

    function render() {
      resetChatIfContextChanged();
      if (graded && currentIdx === -1) {
        renderResults();
      } else {
        renderQuestion(currentIdx);
      }
      renderBottomBar();
      // Scroll left pane to top when switching questions
      document.querySelector('.pane-left').scrollTop = 0;
    }

    // --- Actions ---

    function go(delta) {
      currentIdx = Math.max(0, Math.min(examQuestions.length - 1, currentIdx + delta));
      render();
    }

    function checkExam() {
      const answered = answers.filter(a => a !== -1).length;
      const total = examQuestions.length;
      const unanswered = total - answered;
      let msg = `Has contestado ${answered} de ${total} preguntas.`;
      if (unanswered > 0) msg += ` Quedan ${unanswered} sin contestar.`;
      document.getElementById('confirm-msg').textContent = msg;
      document.getElementById('confirm-overlay').classList.add('visible');
    }

    function closeConfirm() {
      document.getElementById('confirm-overlay').classList.remove('visible');
    }

    function confirmCheckExam() {
      closeConfirm();
      graded = true;
      gradeResults = examQuestions.map((q, i) => {
        if (answers[i] === -1) return 'unanswered';
        return answers[i] === q.answer ? 'correct' : 'wrong';
      });
      errorIndices = [];
      gradeResults.forEach((r, i) => { if (r !== 'correct') errorIndices.push(i); });
      currentErrorIdx = 0;
      currentIdx = -1; // show results
      render();
    }

    function nextError() {
      if (errorIndices.length === 0) return;
      currentIdx = errorIndices[currentErrorIdx];
      currentErrorIdx = (currentErrorIdx + 1) % errorIndices.length;
      render();
    }

    function nextQuestion() {
      if (!graded) return;
      if (currentIdx === -1) { currentIdx = 0; }
      else { currentIdx = (currentIdx + 1) % examQuestions.length; }
      render();
    }

    function newExam() {
      graded = false;
      gradeResults = [];
      errorIndices = [];
      currentErrorIdx = 0;
      currentIdx = 0;
      const pool = getFilteredPool();
      examQuestions = shuffle([...pool]).slice(0, Math.min(examSize, pool.length));
      answers = new Array(examQuestions.length).fill(-1);
      document.getElementById('slider-count').max = pool.length;
      document.getElementById('btn-settings').classList.remove('hidden');
      updateExamFilterLabel();
      render();
    }

    function selectAnswer(ci) {
      if (graded || currentIdx < 0) return;
      const q = examQuestions[currentIdx];
      if (ci >= q.choices.length) return;
      answers[currentIdx] = ci;
      document.getElementById('btn-settings').classList.add('hidden');
      const view = document.getElementById('view');
      view.querySelectorAll('#choices label').forEach(l => l.classList.remove('selected'));
      const label = view.querySelector(`#choices label[data-ci="${ci}"]`);
      if (label) {
        label.classList.add('selected');
        label.querySelector('input').checked = true;
      }
      if (currentIdx < examQuestions.length - 1) {
        setTimeout(() => { currentIdx = currentIdx + 1; render(); }, 350);
      } else {
        renderBottomBar();
      }
    }

    function toggleLongExplanation() {
      if (!graded || currentIdx < 0) return;
      const q = examQuestions[currentIdx];
      if (isMobile()) {
        const newMode = currentExplMode === 'short' ? 'long' : 'short';
        prepareExplanationPane(q, newMode);
        updateExplButtons();
      } else {
        showExplanationPane(q, currentExplMode === 'short' ? 'long' : 'short');
      }
    }

    // Settings modal
    function openSettings() {
      document.getElementById('topic-filter-select').value = examTopicFilter ?? '';
      const pool = getFilteredPool();
      const sliderEl = document.getElementById('slider-count');
      sliderEl.max = pool.length;
      const capped = Math.min(examSize, pool.length);
      sliderEl.value = capped;
      document.getElementById('slider-value').textContent = capped;
      document.getElementById('modal-overlay').classList.add('visible');
    }

    function closeSettings() {
      document.getElementById('modal-overlay').classList.remove('visible');
    }

    function applySettings() {
      examSize = parseInt(document.getElementById('slider-count').value);
      const sel = document.getElementById('topic-filter-select');
      examTopicFilter   = sel.value ? parseInt(sel.value) : null;
      examSectionFilter = null;  // topic change resets any section filter
      closeSettings();
      newExam();
    }

    document.getElementById('slider-count').addEventListener('input', (e) => {
      document.getElementById('slider-value').textContent = e.target.value;
    });

    document.getElementById('modal-overlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeSettings();
    });

    document.getElementById('confirm-overlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeConfirm();
    });

    // Close heading dropdowns on outside click or Escape
    document.addEventListener('click', () => {
      document.querySelectorAll('.heading-dropdown.open').forEach(d => d.classList.remove('open'));
    });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.heading-dropdown.open').forEach(d => d.classList.remove('open'));
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (appMode !== 'exam') return;
      // When confirm modal is open, Enter confirms, Escape cancels
      const confirmOpen = document.getElementById('confirm-overlay').classList.contains('visible');
      if (confirmOpen) {
        if (e.key === 'Enter') confirmCheckExam();
        if (e.key === 'Escape') closeConfirm();
        return;
      }
      if (e.key === 'ArrowLeft') go(-1);
      if (e.key === 'ArrowRight') {
        if (graded && errorIndices.length > 0) nextError();
        else go(1);
      }
      if (e.key === ' ' && graded) { e.preventDefault(); nextQuestion(); }
      if (e.key === 'ArrowLeft' && graded) go(-1);
      // 1-4 to select answer
      if (['1','2','3','4'].includes(e.key)) selectAnswer(parseInt(e.key) - 1);
      // i to toggle detailed explanation
      if (e.key === 'i' || e.key === 'I') toggleLongExplanation();
      // Cmd+Enter to submit exam
      if (e.key === 'Enter' && e.metaKey && !graded) { e.preventDefault(); checkExam(); }
      // Enter to go to next error (post-grading results screen)
      if (e.key === 'Enter' && !e.metaKey && graded && currentIdx === -1) nextError();
      // Escape to close explanation pane
      if (e.key === 'Escape') hideExplanationPane();
      // Cmd+R to start new exam (prevent browser reload)
      if (e.key === 'r' && e.metaKey) { e.preventDefault(); newExam(); }
    });

    // --- Mode switching ---

    function switchMode(mode, { silent = false } = {}) {
      appMode = mode;
      document.querySelectorAll('.mode-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      document.getElementById('exam-view').style.display = mode === 'exam' ? 'flex' : 'none';
      document.getElementById('study-view').style.display = mode === 'study' ? 'flex' : 'none';
      document.body.classList.toggle('mode-study', mode === 'study');
      if (mode === 'study' && !studySidebarRendered) {
        renderStudySidebar();
        studySidebarRendered = true;
      }
      if (!silent) updateURL();
    }

    // --- Study view ---

    const topics = [
      { id: 1,  file: 'temario/Tema 1 - Administración del SO y Software Base.md', title: 'Tema 1: Administración del SO y Software Base' },
      { id: 2,  file: 'temario/Tema 2 - Administración de Bases de Datos.md', title: 'Tema 2: Administración de Bases de Datos' },
      { id: 3,  file: 'temario/Tema 3 - Servidores de Correo, Contenedores y Microservicios.md', title: 'Tema 3: Servidores de Correo, Contenedores y Microservicios' },
      { id: 4,  file: 'temario/Tema 4 - Administración de Redes de Área Local.md', title: 'Tema 4: Administración de Redes de Área Local' },
      { id: 5,  file: 'temario/Tema 5 - Conceptos de Seguridad de los Sistemas de Información.md', title: 'Tema 5: Conceptos de Seguridad de los Sistemas de Información' },
      { id: 6,  file: 'temario/Tema 6 - Comunicaciones y Medios de Transmisión.md', title: 'Tema 6: Comunicaciones y Medios de Transmisión' },
      { id: 7,  file: 'temario/Tema 7 - Modelo TCP-IP y Modelo OSI.md', title: 'Tema 7: Modelo TCP-IP y Modelo OSI' },
      { id: 8,  file: 'temario/Tema 8 - Arquitectura de Red Internet.md', title: 'Tema 8: Arquitectura de Red Internet' },
      { id: 9,  file: 'temario/Tema 9 - Seguridad y Protección en Redes.md', title: 'Tema 9: Seguridad y Protección en Redes' },
      { id: 10, file: 'temario/Tema 10 - Redes Locales.md', title: 'Tema 10: Redes Locales' },
    ];

    let studySidebarRendered = false;
    let currentTopicId = null;
    let currentSectionId = null;
    let tocObserver = null;

    function updateURL() {
      let hash = '';
      if (appMode === 'study') {
        hash = '#study';
        if (currentTopicId) hash += '/' + currentTopicId;
        if (currentSectionId) hash += '/' + currentSectionId;
      } else if (appMode === 'exam' && examTopicFilter) {
        hash = '#exam/topic/' + examTopicFilter;
        if (examSectionFilter) hash += '/section/' + examSectionFilter;
      }
      history.replaceState(null, '', window.location.pathname + window.location.search + hash);
    }

    function parseHashAndNavigate() {
      const hash = window.location.hash.slice(1);
      if (hash.startsWith('exam/topic/')) {
        const parts = hash.split('/');  // ['exam','topic','3','section','slug']
        examTopicFilter   = parseInt(parts[2]) || null;
        examSectionFilter = (parts[3] === 'section' && parts[4]) ? parts[4] : null;
        switchMode('exam', { silent: true });
        newExam();
        return;
      }
      if (!hash.startsWith('study')) return;
      const parts = hash.split('/');
      switchMode('study', { silent: true });
      const topicId = parseInt(parts[1]);
      const sectionId = parts[2] || null;
      if (topicId) loadTopic(topicId, sectionId, { silent: true });
    }

    function renderStudySidebar() {
      const nav = document.getElementById('study-sidebar-nav');
      nav.innerHTML = topics.map(t =>
        `<a href="#study/${t.id}" data-topic-id="${t.id}" onclick="loadTopic(${t.id}); return false;">${t.title}</a>`
      ).join('');
    }

    function loadTopic(topicId, initialSectionId = null, { silent = false } = {}) {
      const topic = topics.find(t => t.id === topicId);
      if (!topic) return;
      currentTopicId = topicId;
      currentSectionId = null;
      resetChatIfContextChanged();

      // Update sidebar active state
      document.querySelectorAll('#study-sidebar-nav a').forEach(a => {
        a.classList.toggle('active', parseInt(a.dataset.topicId) === topicId);
      });

      // Close mobile sidebar if open
      if (window.matchMedia('(max-width: 768px)').matches) {
        document.getElementById('study-sidebar').classList.remove('open');
        document.getElementById('study-sidebar-overlay').classList.remove('visible');
      }

      if (!silent) updateURL();

      const contentInner = document.getElementById('study-content-inner');
      contentInner.innerHTML = '<div class="study-placeholder">Cargando...</div>';

      fetch(topic.file)
        .then(r => {
          if (!r.ok) throw new Error('Not found');
          return r.text();
        })
        .then(md => {
          const html = marked.parse(md);
          contentInner.innerHTML = html;

          // Wrap tables in scrollable containers
          contentInner.querySelectorAll('table').forEach(table => {
            const wrapper = document.createElement('div');
            wrapper.className = 'study-table-wrapper';
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
          });

          // Add IDs to headings for TOC linking
          addHeadingIds(contentInner);

          // Build TOC in left sidebar
          buildTOC(contentInner);

          // Switch left sidebar to sections view
          document.getElementById('study-sidebar-topics').style.display = 'none';
          document.getElementById('study-sidebar-section-title').textContent = topic.title;
          document.getElementById('study-sidebar-sections').style.display = '';

          if (initialSectionId) {
            scrollToHeading(initialSectionId, { silent: true });
          } else {
            // Scroll to top
            document.getElementById('study-content').scrollTop = 0;
          }

          // Setup TOC highlight
          setupTocHighlight();
        })
        .catch(() => {
          contentInner.innerHTML = '<div class="study-placeholder" style="color:#e74c3c;">Error cargando el tema. Asegúrate de servir la página con un servidor local.</div>';
        });
    }

    function addHeadingIds(container) {
      const headings = container.querySelectorAll('h1, h2, h3, h4');
      const headingArr = Array.from(headings);
      const usedIds = new Set();

      // Pass 1 — assign IDs (read textContent before any children are added)
      headingArr.forEach(h => {
        let id = h.textContent.trim()
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[^\w\s-]/g, '')
          .replace(/\s+/g, '-')
          .substring(0, 80);
        let base = id, counter = 1;
        while (usedIds.has(id)) id = base + '-' + counter++;
        usedIds.add(id);
        h.id = id;
      });

      // Pass 2 — build anchor + dropdown using DOM-level hierarchy for counts
      headingArr.forEach((h, i) => {
        const id = h.id;
        const level = parseInt(h.tagName[1]);

        const anchor = document.createElement('a');
        anchor.href = `#study/${currentTopicId}/${id}`;
        anchor.className = 'heading-anchor';
        anchor.textContent = '#';
        anchor.addEventListener('click', e => { e.preventDefault(); e.stopPropagation(); scrollToHeading(id); });
        h.appendChild(anchor);

        // Effective count = direct questions at this heading + all deeper subsections
        let effectiveCount = 0;
        for (let j = i; j < headingArr.length; j++) {
          if (j > i && parseInt(headingArr[j].tagName[1]) <= level) break;
          effectiveCount += sectionQuestionCounts.get(headingArr[j].id) || 0;
        }

        // Dropdown menu — heading itself is the trigger
        const dropdown = document.createElement('div');
        dropdown.className = 'heading-dropdown';
        h.addEventListener('click', e => {
          e.stopPropagation();
          document.querySelectorAll('.heading-dropdown.open').forEach(d => {
            if (d !== dropdown) d.classList.remove('open');
          });
          dropdown.classList.toggle('open');
        });

        // Chat item
        const chatItem = document.createElement('button');
        chatItem.className = 'heading-dropdown-item';
        chatItem.textContent = '💬 Hablar con Claude sobre esto';
        chatItem.addEventListener('click', e => {
          e.stopPropagation();
          dropdown.classList.remove('open');
          scrollToHeading(id);
          openChatPanel();
        });
        dropdown.appendChild(chatItem);

        // Exam item
        const examItem = document.createElement('button');
        examItem.className = 'heading-dropdown-item';
        if (effectiveCount > 0) {
          examItem.textContent = `📝 Hacer examen de esto (${effectiveCount} pregunta${effectiveCount === 1 ? '' : 's'})`;
          examItem.addEventListener('click', e => {
            e.stopPropagation();
            dropdown.classList.remove('open');
            const url = location.href.split('#')[0]
              + '#exam/topic/' + currentTopicId + '/section/' + id;
            window.open(url, '_blank');
          });
        } else {
          examItem.textContent = 'No hay preguntas disponibles de esta sección';
          examItem.disabled = true;
        }
        dropdown.appendChild(examItem);
        h.appendChild(dropdown);
      });
    }

    function buildTOC(container) {
      const tocNav = document.getElementById('study-sidebar-toc-nav');
      const headings = container.querySelectorAll('h2, h3');
      if (headings.length === 0) {
        tocNav.innerHTML = '<div style="padding:8px 16px;color:#aaa;font-size:0.82rem;">Sin secciones</div>';
        return;
      }
      tocNav.innerHTML = Array.from(headings).map(h => {
        const level = h.tagName === 'H3' ? 'toc-h3' : '';
        const clone = h.cloneNode(true);
        clone.querySelectorAll('.heading-anchor, .heading-dropdown').forEach(el => el.remove());
        const text = clone.textContent.trim();
        return `<a href="#study/${currentTopicId}/${h.id}" class="${level}" onclick="scrollToHeading('${h.id}'); return false;">${text}</a>`;
      }).join('');
    }

    function scrollToHeading(id, { silent = false } = {}) {
      const el = document.getElementById(id);
      if (!el) return;
      currentSectionId = id;
      resetChatIfContextChanged();
      if (!silent) updateURL();
      el.scrollIntoView({ behavior: 'smooth' });

      // Close mobile sidebar after navigating to a section
      if (window.matchMedia('(max-width: 768px)').matches) {
        document.getElementById('study-sidebar').classList.remove('open');
        document.getElementById('study-sidebar-overlay').classList.remove('visible');
      }
    }

    function setupTocHighlight() {
      // Clean up previous observer
      if (tocObserver) tocObserver.disconnect();

      const contentEl = document.getElementById('study-content');
      const headings = document.getElementById('study-content-inner').querySelectorAll('h2, h3');
      if (headings.length === 0) return;

      tocObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const id = entry.target.id;
            currentSectionId = id;
            updateURL();
            document.querySelectorAll('#study-sidebar-toc-nav a').forEach(a => {
              const isActive = a.getAttribute('href') === `#study/${currentTopicId}/${id}`;
              a.classList.toggle('active', isActive);
              if (isActive) a.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            });
            // Keep chat panel label and context in sync while scrolling
            const panel = document.getElementById('chat-panel');
            if (panel && panel.classList.contains('open')) {
              const ctx = getCurrentContext();
              if (chatMessages.length === 0) {
                chatContextKey = ctx ? ctx.key : null;
                chatSystemPrompt = buildSystemPrompt(ctx);
              }
              updateChatContextLabel(ctx);
            }
          }
        });
      }, {
        root: contentEl,
        rootMargin: '0px 0px -70% 0px',
        threshold: 0
      });

      headings.forEach(h => tocObserver.observe(h));
    }

    // Mobile sidebar toggle
    function toggleStudySidebar() {
      const sidebar = document.getElementById('study-sidebar');
      const overlay = document.getElementById('study-sidebar-overlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('visible');
    }

    // Mobile TOC toggle
    function toggleStudyToc() {
      const overlay = document.getElementById('study-toc-overlay');
      overlay.classList.remove('visible');
    }

    function showTopicsList() {
      document.getElementById('study-sidebar-sections').style.display = 'none';
      document.getElementById('study-sidebar-topics').style.display = '';
    }

    function toggleSidebarCollapse() {
      const sidebar = document.getElementById('study-sidebar');
      const btn = document.getElementById('sidebar-collapse-btn');
      const isCollapsed = sidebar.classList.toggle('collapsed');
      btn.querySelector('.icon-collapse').style.display = isCollapsed ? 'none' : '';
      btn.querySelector('.icon-expand').style.display = isCollapsed ? '' : 'none';
      btn.title = isCollapsed ? 'Expandir panel' : 'Contraer panel';
      localStorage.setItem('opo_sidebar_collapsed', isCollapsed ? '1' : '0');
    }

    (function restoreSidebarCollapsed() {
      if (localStorage.getItem('opo_sidebar_collapsed') === '1') {
        const sidebar = document.getElementById('study-sidebar');
        const btn = document.getElementById('sidebar-collapse-btn');
        sidebar.classList.add('collapsed');
        btn.querySelector('.icon-collapse').style.display = 'none';
        btn.querySelector('.icon-expand').style.display = '';
        btn.title = 'Expandir panel';
      }
    })();

    document.getElementById('study-sidebar-back').addEventListener('click', showTopicsList);

    function updateExamFilterLabel() {
      const label = document.getElementById('exam-filter-label');
      const text  = document.getElementById('exam-filter-label-text');
      if (examTopicFilter || examSectionFilter) {
        const topic = topics.find(t => t.id === examTopicFilter);
        const parts = [];
        if (topic) parts.push(topic.title);
        if (examSectionFilter) parts.push(examSectionFilter.replace(/-/g, ' '));
        text.textContent = 'Filtrando: ' + parts.join(' › ');
        label.classList.add('visible');
      } else {
        label.classList.remove('visible');
      }
    }

    // Populate topic filter select and wire change + clear + sidebar buttons
    (function initExamFilters() {
      const sel = document.getElementById('topic-filter-select');
      topics.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.title;
        sel.appendChild(opt);
      });

      // Live-update slider max when topic changes in modal
      sel.addEventListener('change', function() {
        const tid = this.value ? parseInt(this.value) : null;
        const pool = tid ? allQuestions.filter(q => q.topic === tid) : allQuestions;
        const slider = document.getElementById('slider-count');
        slider.max = pool.length;
        if (parseInt(slider.value) > pool.length) slider.value = pool.length;
        document.getElementById('slider-value').textContent = slider.value;
      });

      // Clear filter button
      document.getElementById('exam-filter-clear').addEventListener('click', () => {
        examTopicFilter = null;
        examSectionFilter = null;
        document.getElementById('topic-filter-select').value = '';
        newExam();
      });

      // "Examen de este tema" in study sidebar → open new tab
      document.getElementById('btn-topic-exam').addEventListener('click', () => {
        const url = location.href.split('#')[0] + '#exam/topic/' + currentTopicId;
        window.open(url, '_blank');
      });
    })();

    // ── Ask Claude chat ──────────────────────────────────────────

    let chatMessages = [];
    let chatSystemPrompt = '';
    let chatContextKey = null;

    function getChatApiKey() {
      return localStorage.getItem('opo_claude_api_key') || '';
    }

    function setChatApiKey(key) {
      localStorage.setItem('opo_claude_api_key', key.trim());
    }

    function getExamContext() {
      if (!examQuestions.length || currentIdx < 0) return null;
      const q = examQuestions[currentIdx];
      const choiceLines = q.choices
        .map((c, i) => `  ${i + 1}. ${c}${graded && i === q.answer ? ' [CORRECTA]' : ''}`)
        .join('\n');
      const label = `Pregunta ${currentIdx + 1} · ${q.section || 'Tema ' + q.topic}`;
      const content = `Tema: ${q.topic} — ${q.section || ''}
Pregunta: ${q.question}
Opciones:
${choiceLines}
Explicación breve: ${q.short_explanation}
Explicación detallada: ${q.long_explanation}`.trim();
      return { label, content, key: `exam-${currentIdx}` };
    }

    function getStudyContext() {
      if (!currentTopicId) return null;
      const topic = topics.find(t => t.id === currentTopicId);
      const heading = currentSectionId ? document.getElementById(currentSectionId) : null;
      let sectionTitle = null;
      if (heading) {
        const clone = heading.cloneNode(true);
        clone.querySelectorAll('.heading-anchor, .heading-dropdown').forEach(el => el.remove());
        sectionTitle = clone.textContent.trim();
      }
      let sectionText = '';
      if (heading) {
        const currentLevel = parseInt(heading.tagName[1]);
        let el = heading.nextSibling;
        const parts = [];
        while (el) {
          if (el.nodeType === Node.ELEMENT_NODE && /^H[1-6]$/.test(el.tagName) && parseInt(el.tagName[1]) <= currentLevel) break;
          const t = el.textContent?.trim();
          if (t) parts.push(t);
          el = el.nextSibling;
        }
        sectionText = parts.join('\n').substring(0, 6000);
      }
      const label = topic.title + (sectionTitle ? ' — ' + sectionTitle : '');
      const content = sectionText
        ? `El estudiante está leyendo la sección "${sectionTitle}" del tema "${topic.title}".\n\nContenido de la sección:\n${sectionText}`
        : `El estudiante está leyendo el tema "${topic.title}".`;
      return { label, content, key: `study-${currentTopicId}-${currentSectionId}` };
    }

    function getCurrentContext() {
      if (appMode === 'exam') return getExamContext();
      if (appMode === 'study') return getStudyContext();
      return null;
    }

    function buildSystemPrompt(ctx) {
      const modeStr = appMode === 'exam' ? 'haciendo un examen de práctica' : 'leyendo material de estudio';
      return `Eres un tutor para las oposiciones de Administradores de Sistemas del Estado español.
El estudiante está actualmente ${modeStr}.

--- CONTEXTO ---
${ctx ? ctx.content : 'Sin contexto específico.'}
--- FIN DEL CONTEXTO ---

Responde en español. Sé claro y conciso. Cuando sea relevante, cita conceptos específicos del contexto.`;
    }

    function resetChatIfContextChanged() {
      const ctx = getCurrentContext();
      const newKey = ctx ? ctx.key : null;
      if (newKey === chatContextKey) return;

      const hadMessages = chatMessages.length > 0;
      chatMessages = [];
      chatContextKey = newKey;
      chatSystemPrompt = buildSystemPrompt(ctx);

      const panel = document.getElementById('chat-panel');
      if (panel && panel.classList.contains('open')) {
        const messagesEl = document.getElementById('chat-messages');
        if (messagesEl) {
          if (hadMessages) {
            const notice = document.createElement('div');
            notice.className = 'chat-notice';
            notice.textContent = 'Contexto actualizado';
            messagesEl.innerHTML = '';
            messagesEl.appendChild(notice);
          } else {
            messagesEl.innerHTML = '';
          }
        }
        updateChatContextLabel(ctx);
      }
    }

    function updateChatContextLabel(ctx) {
      const el = document.getElementById('chat-context-label');
      if (!el) return;
      ctx = ctx || getCurrentContext();
      el.textContent = ctx ? ctx.label : '';
    }

    function openChatPanel() {
      const apiKey = getChatApiKey();
      if (!apiKey) { openApiKeyModal(); return; }

      const ctx = getCurrentContext();
      const newKey = ctx ? ctx.key : null;
      if (newKey !== chatContextKey) {
        // Update context for future messages without clearing history
        chatContextKey = newKey;
        chatSystemPrompt = buildSystemPrompt(ctx);
      }

      updateChatContextLabel(ctx);
      document.getElementById('chat-panel').classList.add('open');
      document.getElementById('btn-ask-claude').classList.add('active');
      setTimeout(() => document.getElementById('chat-input')?.focus(), 100);
    }

    function closeChatPanel() {
      document.getElementById('chat-panel').classList.remove('open');
      document.getElementById('btn-ask-claude').classList.remove('active');
    }

    function appendChatMessage(role, text) {
      const messagesEl = document.getElementById('chat-messages');
      const msgEl = document.createElement('div');
      if (role === 'error') {
        msgEl.className = 'chat-msg error';
        const bubble = document.createElement('div');
        bubble.className = 'chat-msg-bubble';
        bubble.textContent = text;
        msgEl.appendChild(bubble);
      } else {
        msgEl.className = `chat-msg ${role}`;
        const bubble = document.createElement('div');
        bubble.className = 'chat-msg-bubble';
        bubble.textContent = text;
        msgEl.appendChild(bubble);
      }
      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) return;

      const apiKey = getChatApiKey();
      if (!apiKey) { openApiKeyModal(); return; }

      input.value = '';
      input.style.height = '44px';

      appendChatMessage('user', text);
      chatMessages.push({ role: 'user', content: text });

      const messagesEl = document.getElementById('chat-messages');
      const typingEl = document.createElement('div');
      typingEl.className = 'chat-msg assistant';
      typingEl.innerHTML = '<div class="chat-msg-bubble chat-typing"><span></span><span></span><span></span></div>';
      messagesEl.appendChild(typingEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      const sendBtn = document.getElementById('chat-send-btn');
      sendBtn.disabled = true;

      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true',
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-6',
            max_tokens: 1024,
            stream: true,
            system: chatSystemPrompt,
            messages: chatMessages,
          }),
        });

        typingEl.remove();

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          const msg = err?.error?.message || `Error ${response.status}`;
          appendChatMessage('error', msg);
          chatMessages.pop();
          return;
        }

        // Create the assistant bubble and scroll its top into view
        const msgEl = document.createElement('div');
        msgEl.className = 'chat-msg assistant';
        const bubble = document.createElement('div');
        bubble.className = 'chat-msg-bubble';
        msgEl.appendChild(bubble);
        messagesEl.appendChild(msgEl);
        messagesEl.scrollTop = msgEl.offsetTop - messagesEl.offsetTop - 8;

        // Read the SSE stream
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let accumulated = '';
        let sseBuffer = '';
        let renderScheduled = false;

        const scheduleRender = () => {
          if (renderScheduled) return;
          renderScheduled = true;
          requestAnimationFrame(() => {
            bubble.innerHTML = marked.parse(accumulated);
            renderScheduled = false;
          });
        };

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          sseBuffer += decoder.decode(value, { stream: true });
          const lines = sseBuffer.split('\n');
          sseBuffer = lines.pop(); // keep any incomplete last line

          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            const payload = line.slice(6).trim();
            if (payload === '[DONE]') break;
            try {
              const event = JSON.parse(payload);
              if (event.type === 'content_block_delta' && event.delta?.type === 'text_delta') {
                accumulated += event.delta.text;
                scheduleRender();
              }
            } catch (_) { /* incomplete chunk — skip */ }
          }
        }

        // Ensure the final state is fully rendered
        bubble.innerHTML = marked.parse(accumulated);
        chatMessages.push({ role: 'assistant', content: accumulated });

      } catch (err) {
        typingEl.remove();
        appendChatMessage('error', 'Error de conexión. Comprueba tu conexión a internet.');
        chatMessages.pop();
      } finally {
        sendBtn.disabled = false;
        document.getElementById('chat-input')?.focus();
      }
    }

    function openApiKeyModal() {
      const input = document.getElementById('api-key-input');
      input.value = getChatApiKey();
      document.getElementById('api-key-overlay').classList.add('visible');
      setTimeout(() => input.focus(), 100);
    }

    function closeApiKeyModal() {
      document.getElementById('api-key-overlay').classList.remove('visible');
    }

    function applyApiKey() {
      const key = document.getElementById('api-key-input').value.trim();
      if (!key) return;
      setChatApiKey(key);
      closeApiKeyModal();
      openChatPanel();
    }

    document.getElementById('btn-ask-claude').addEventListener('click', () => {
      const panel = document.getElementById('chat-panel');
      if (panel.classList.contains('open')) closeChatPanel();
      else openChatPanel();
    });

    document.getElementById('chat-close-btn').addEventListener('click', closeChatPanel);
    document.getElementById('chat-send-btn').addEventListener('click', sendChatMessage);

    document.getElementById('chat-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
    });

    document.getElementById('chat-input').addEventListener('input', (e) => {
      const el = e.target;
      el.style.height = '44px';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    });

    document.getElementById('api-key-overlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeApiKeyModal();
    });

    document.getElementById('api-key-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') applyApiKey();
      if (e.key === 'Escape') closeApiKeyModal();
    });

    // Chat panel resize
    (function() {
      const panel = document.getElementById('chat-panel');
      const handle = document.getElementById('chat-resize-handle');
      let dragging = false, startX, startWidth;

      const savedWidth = localStorage.getItem('opo_chat_width');
      if (savedWidth) panel.style.width = savedWidth;

      handle.addEventListener('mousedown', e => {
        dragging = true;
        startX = e.clientX;
        startWidth = panel.offsetWidth;
        handle.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', e => {
        if (!dragging) return;
        const newWidth = Math.max(320, Math.min(1200, startWidth + (startX - e.clientX)));
        panel.style.width = newWidth + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (!dragging) return;
        dragging = false;
        handle.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        localStorage.setItem('opo_chat_width', panel.style.width);
      });
    })();

    // ── End Ask Claude chat ──────────────────────────────────────

    // --- Init ---
    window.addEventListener('popstate', parseHashAndNavigate);

    fetch('questions.json')
      .then(r => r.json())
      .then(data => {
        allQuestions = data;
        allQuestions.forEach(q => {
          const slug = sectionToSlug(q.section);
          sectionQuestionCounts.set(slug, (sectionQuestionCounts.get(slug) || 0) + 1);
          if (!slugToSectionText.has(slug)) slugToSectionText.set(slug, q.section);
        });
        document.getElementById('slider-count').max = allQuestions.length;
        examQuestions = shuffle([...allQuestions]).slice(0, examSize);
        answers = new Array(examQuestions.length).fill(-1);
        render();
        parseHashAndNavigate();
      })
      .catch(() => {
        document.getElementById('view').innerHTML =
          '<p style="color:red;text-align:center;padding:40px;">Error cargando questions.json. Asegúrate de servir la página con un servidor local (python3 -m http.server).</p>';
      });
  </script>
</body>
</html>
